{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",


    "parameters": {
                   "appName": { "type": "string", "defaultValue": "myapp",                                                     "metadata": { "description": "Name of Application"                            } },
            "appEnvironment": { "type": "string", "defaultValue": "dev",   "allowedValues": [ "dev", "qa", "prod" ],           "metadata": { "description": "Environment for Application"                    } },
          "nvaInstanceCount": { "type": "int",    "defaultValue": 2,                                                           "metadata": { "description": "Number of nva Tier Instances to create"         } },
          "staInstanceCount": { "type": "int",    "defaultValue": 3,                                                           "metadata": { "description": "Number of Business Layer Instances to create"   } },
          "stbInstanceCount": { "type": "int",    "defaultValue": 3,                                                           "metadata": { "description": "Number of Business Layer Instances to create"   } },
          "sqlInstanceCount": { "type": "int",    "defaultValue": 3,                                                           "metadata": { "description": "Number of SQL Instances to create"              } },
           "adInstanceCount": { "type": "int",    "defaultValue": 2,                                                           "metadata": { "description": "Number of Active Directory Instances to create" } },
          "adminAccessRange": { "type": "string", "defaultValue": "216.21.164.178",                                            "metadata": { "description": "Network subnet where Admins live"               } },
              "templatePath": { "type": "string", "defaultValue": "https://azureclisa.blob.core.windows.net/sharedresources/", "metadata": { "description": "Path to templates for this implmentation"       } },
        "commonTemplatePath": { "type": "string", "defaultValue": "https://azureclisa.blob.core.windows.net/templates/",       "metadata": { "description": "Path to core/common/reusable templatess"        } }
    },


    "variables": {

        "commonSettings": {
            "resourceApiVersion": "2016-02-01",       // all tempaltes in this hierarchical project use this value for  "type": "Microsoft.Resources/deployments",
                  "templatePath": "[parameters(      'templatePath')]",
            "commonTemplatePath": "[parameters('commonTemplatePath')]"
        },

        "vnetAddressRange": "10.0.0.0/16",

        "diagStorageAccountName": "[concat(parameters('appName'), uniqueString(resourceGroup().id,'diag'))]",
        "diskStorageAccountRoot": "[concat(parameters('appName'), uniqueString(resourceGroup().id,'disk'))]",
        "appPublicIPAddressName": "[concat(parameters('appName'), uniqueString(resourceGroup().id,'pip' ))]",
         "jbPublicIPAddressName": "[concat(parameters('appName'), uniqueString(resourceGroup().id,'Jpip'))]",

        "virtualNetworkName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-vnet')]",

        "nvaLoadBalancerName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-nva-lb')]",
        "staLoadBalancerName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-sta-lb')]",
        "stbLoadBalancerName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-stb-lb')]",
        "sqlLoadBalancerName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-sql-lb')]",

          "nvaPublicSubnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),   '-nva-public-subnet')]",
         "nvaPrivateSubnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-nva-private-subnet')]",
                "staSubnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),          '-sta-subnet')]",
                "stbSubnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),          '-stb-subnet')]",
                "sqlSubnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),          '-sql-subnet')]",
               "mgmtSubnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),         '-mgmt-subnet')]",
                 "adSubnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),           '-ad-subnet')]",

        "nvaAvailabilitySetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-nva-as')]",
        "staAvailabilitySetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-sta-as')]",
        "stbAvailabilitySetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-stb-as')]",
        "sqlAvailabilitySetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-sql-as')]",
         "adAvailabilitySetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-ad-as')]",

         "nvaVmName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-nva-vm')]",
         "staVmName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-sta-vm')]",
         "stbVmName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-stb-vm')]",
         "sqlVmName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-sql-vm')]",
        "mgmtVmName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-mgmt-vm')]",
          "adVmName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),   '-ad-vm')]"

    },

    "resources": [

        {
                  "name": "shared",
                  "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('commonSettings').resourceApiVersion]",

            "properties": {
                "mode": "incremental",
                "templateLink": { "uri": "[concat(variables('commonSettings').templatePath,'vdc-shared-azuredeploy.json')]" },

                "parameters": {
                    "commonSettings":         { "value": "[variables('commonSettings')]"         },
                        "virtualNetworkName": { "value": "[variables(    'virtualNetworkName')]" },
                       "virtualNetworkRange": { "value": "[variables(      'vnetAddressRange')]" },
                    "diagStorageAccountName": { "value": "[variables('diagStorageAccountName')]" }
                }
            }
        },



        {
                  "name": "known",
                  "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('commonSettings').resourceApiVersion]",

            "dependsOn": [ "Microsoft.Resources/deployments/shared" ],

            "properties": {
                "mode": "incremental",
                "templateLink": { "uri": "[concat(variables('commonSettings').templatePath,'vdc-known-azuredeploy.json')]" },

                "parameters": {
                    "commonSettings":         { "value": "[variables('commonSettings')]"          },
                        "virtualNetworkName": { "value": "[variables(    'virtualNetworkName')]"  },
                    "diagStorageAccountName": { "value": "[variables('diagStorageAccountName')]"  },
                    "diskStorageAccountRoot": { "value": "[variables('diskStorageAccountRoot')]"  },

                    "nvaPublicIPAddressName": { "value": "[variables( 'appPublicIPAddressName')]" },
                     "jbPublicIPAddressName": { "value": "[variables(  'jbPublicIPAddressName')]" },

                       "nvaLoadBalancerName": { "value": "[variables(   'nvaLoadBalancerName')]"  },
                       "nvaPublicSubnetName": { "value": "[variables(   'nvaPublicSubnetName')]"  },
                      "nvaPrivateSubnetName": { "value": "[variables(  'nvaPrivateSubnetName')]"  },
                    "nvaAvailabilitySetName": { "value": "[variables('nvaAvailabilitySetName')]"  },
                          "nvaInstanceCount": { "value": "[parameters(     'nvaInstanceCount')]"  },
                                 "nvaVmName": { "value": "[variables(             'nvaVmName')]"  },
                    
                       "staLoadBalancerName": { "value": "[variables(   'staLoadBalancerName')]"  },
                             "staSubnetName": { "value": "[variables(         'staSubnetName')]"  },
                    "staAvailabilitySetName": { "value": "[variables('staAvailabilitySetName')]"  },
                          "staInstanceCount": { "value": "[parameters(     'staInstanceCount')]"  },
                                 "staVmName": { "value": "[variables(             'staVmName')]"  },

                       "stbLoadBalancerName": { "value": "[variables(   'stbLoadBalancerName')]"  },
                             "stbSubnetName": { "value": "[variables(         'stbSubnetName')]"  },
                    "stbAvailabilitySetName": { "value": "[variables('stbAvailabilitySetName')]"  },
                          "stbInstanceCount": { "value": "[parameters(     'stbInstanceCount')]"  },
                                 "stbVmName": { "value": "[variables(             'stbVmName')]"  },

                       "sqlLoadBalancerName": { "value": "[variables(    'sqlLoadBalancerName')]" },
                             "sqlSubnetName": { "value": "[ variables(         'sqlSubnetName')]" },
                    "sqlAvailabilitySetName": { "value": "[ variables('sqlAvailabilitySetName')]" },
                          "sqlInstanceCount": { "value": "[parameters(      'sqlInstanceCount')]" },
                                 "sqlVmName": { "value": "[ variables(             'sqlVmName')]" },

                            "mgmtSubnetName": { "value": "[ variables(        'mgmtSubnetName')]" },
                                "mgmtVmName": { "value": "[ variables(            'mgmtVmName')]" },
                          "adminAccessRange": { "value": "[parameters(      'adminAccessRange')]" },

                              "adSubnetName": { "value": "[ variables(         'adSubnetName')]" },
                     "adAvailabilitySetName": { "value": "[ variables('adAvailabilitySetName')]" },
                           "adInstanceCount": { "value": "[parameters(      'adInstanceCount')]" },
                                  "adVmName": { "value": "[ variables(             'adVmName')]" }
                }
            }
        }
    ]
}