{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",


    "parameters": {
                  "appName": { "type": "string", "defaultValue": "myapp",                                            "metadata": { "description": "Name of Application"                            }  },
           "appEnvironment": { "type": "string", "defaultValue": "dev",   "allowedValues": [ "dev", "qa", "prod" ],  "metadata": { "description": "Environment for Application"                    }  },
         "nvaInstanceCount": { "type": "int",    "defaultValue": 2,                                                  "metadata": { "description": "Number of nva Tier Instances to create"         }  },
         "staInstanceCount": { "type": "int",    "defaultValue": 3,                                                  "metadata": { "description": "Number of Business Layer Instances to create"   }  },
         "stbInstanceCount": { "type": "int",    "defaultValue": 3,                                                  "metadata": { "description": "Number of Business Layer Instances to create"   }  },
         "sqlInstanceCount": { "type": "int",    "defaultValue": 2,                                                  "metadata": { "description": "Number of SQL Instances to create"              }  },
        "mgmtInstanceCount": { "type": "int",    "defaultValue": 1,                                                  "metadata": { "description": "Number of Management Instances to create"       }  },
          "adInstanceCount": { "type": "int",    "defaultValue": 2,                                                  "metadata": { "description": "Number of Active Directory Instances to create" }  },
         "adminAccessRange": { "type": "string", "defaultValue": "192.168.55.0/24",                                  "metadata": { "description": "Network subnet where Admins live"               }  }
    },


    "variables": {
        "apiVersion": "2016-02-01",

        "vnetAddressRange": "10.0.0.0/16",
        "staPrivateIPAddress": "10.0.2.250",
        "stbPrivateIPAddress": "10.0.3.250",

        "diagStorageAccountName": "[concat(parameters('appName'), uniqueString(resourceGroup().id,'diag'))]",
        "diskStorageAccountRoot": "[concat(parameters('appName'), uniqueString(resourceGroup().id,'disk'))]",
        "appPublicIPAddressName": "[concat(parameters('appName'), uniqueString(resourceGroup().id,'pip' ))]",
        "jbPublicIPAddressName": "[concat(parameters('appName'), uniqueString(resourceGroup().id,'Jpip'))]",

        "virtualNetworkName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-vnet')]",

        "nvaLoadBalancerName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-nva-lb')]",
        "staLoadBalancerName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-sta-lb')]",
        "stbLoadBalancerName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-stb-lb')]",

         "nvaSubnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-nva-subnet')]",
         "staSubnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-sta-subnet')]",
         "stbSubnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-stb-subnet')]",
         "sqlSubnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-sql-subnet')]",
        "mgmtSubnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-mgmt-subnet')]",
         "adSubnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),    '-ad-subnet')]",

        "nvaAvailabilitySetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-nva-as')]",
        "staAvailabilitySetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-sta-as')]",
        "stbAvailabilitySetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-stb-as')]",
        "sqlAvailabilitySetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-sql-as')]",
         "adAvailabilitySetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-ad-as')]",

         "nvaVmName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-nva-vm')]",
         "staVmName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-sta-vm')]",
         "stbVmName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-stb-vm')]",
         "sqlVmName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-sql-vm')]",
        "mgmtVmName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-mgmt-vm')]",
          "adVmName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),   '-ad-vm')]"

    },

    "resources": [

        {
                  "name": "shared",
                  "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('apiVersion')]",

            "properties": {
                "mode": "incremental",
                "templateLink": { "uri": "https://azureclisa.blob.core.windows.net/sharedresources/vdc-shared-azuredeploy.json" },

                "parameters": {
                    "apiVersion":             { "value": "[variables(            'apiVersion')]" },
                        "virtualNetworkName": { "value": "[variables(    'virtualNetworkName')]" },
                       "virtualNetworkRange": { "value": "[variables(      'vnetAddressRange')]" },
                    "diagStorageAccountName": { "value": "[variables('diagStorageAccountName')]" }
                }
            }
        },



        {
                  "name": "known",
                  "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('apiVersion')]",

            "dependsOn": [ "Microsoft.Resources/deployments/shared" ],

            "properties": {
                "mode": "incremental",
                "templateLink": { "uri": "https://azureclisa.blob.core.windows.net/sharedresources/vdc-known-azuredeploy.json" },

                "parameters": {
                    "apiVersion":             { "value": "[variables(            'apiVersion')]"  },
                        "virtualNetworkName": { "value": "[variables(    'virtualNetworkName')]"  },
                    "diagStorageAccountName": { "value": "[variables('diagStorageAccountName')]"  },
                    "diskStorageAccountRoot": { "value": "[variables('diskStorageAccountRoot')]"  },

                    "nvaPublicIPAddressName": { "value": "[variables( 'appPublicIPAddressName')]" },
                       "staPrivateIPAddress": { "value": "[variables('staPrivateIPAddress')    ]" },
                       "stbPrivateIPAddress": { "value": "[variables('stbPrivateIPAddress')    ]" },
                     "jbPublicIPAddressName": { "value": "[variables(  'jbPublicIPAddressName')]" },

                       "nvaLoadBalancerName": { "value": "[variables(   'nvaLoadBalancerName')]"  },
                             "nvaSubnetName": { "value": "[variables(         'nvaSubnetName')]"  },
                    "nvaAvailabilitySetName": { "value": "[variables('nvaAvailabilitySetName')]"  },
                          "nvaInstanceCount": { "value": "[parameters(     'nvaInstanceCount')]"  },
                                 "nvaVmName": { "value": "[variables(             'nvaVmName')]"  },
                    
                       "staLoadBalancerName": { "value": "[variables(   'staLoadBalancerName')]"  },
                             "staSubnetName": { "value": "[variables(         'staSubnetName')]"  },
                    "staAvailabilitySetName": { "value": "[variables('staAvailabilitySetName')]"  },
                          "staInstanceCount": { "value": "[parameters(     'staInstanceCount')]"  },
                                 "staVmName": { "value": "[variables(             'staVmName')]"  },

                       "stbLoadBalancerName": { "value": "[variables(   'stbLoadBalancerName')]"  },
                             "stbSubnetName": { "value": "[variables(         'stbSubnetName')]"  },
                    "stbAvailabilitySetName": { "value": "[variables('stbAvailabilitySetName')]"  },
                          "stbInstanceCount": { "value": "[parameters(     'stbInstanceCount')]"  },
                                 "stbVmName": { "value": "[variables(             'stbVmName')]"  },

                             "sqlSubnetName": { "value": "[ variables(         'sqlSubnetName')]" },
                    "sqlAvailabilitySetName": { "value": "[ variables('sqlAvailabilitySetName')]" },
                          "sqlInstanceCount": { "value": "[parameters(      'sqlInstanceCount')]" },
                                 "sqlVmName": { "value": "[ variables(             'sqlVmName')]" },

                            "mgmtSubnetName": { "value": "[ variables(        'mgmtSubnetName')]" },
                         "mgmtInstanceCount": { "value": "[parameters(     'mgmtInstanceCount')]" },
                                "mgmtVmName": { "value": "[ variables(            'mgmtVmName')]" },
                          "adminAccessRange": { "value": "[parameters(      'adminAccessRange')]" },

                              "adSubnetName": { "value": "[ variables(         'adSubnetName')]" },
                     "adAvailabilitySetName": { "value": "[ variables('adAvailabilitySetName')]" },
                           "adInstanceCount": { "value": "[parameters(      'adInstanceCount')]" },
                                  "adVmName": { "value": "[ variables(             'adVmName')]" }
                }
            }
        }
    ]
}