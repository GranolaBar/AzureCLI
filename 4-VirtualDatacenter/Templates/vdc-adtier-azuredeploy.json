{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    
    "parameters": {
        "commonSettings":           { "type": "object",                     "metadata": { "description": "Common API values"                      } },
        "virtualNetworkParameters": { "type": "object",                     "metadata": { "description": "Common VNET values"                     } },
           "availabilitySetName":   { "type": "string",                     "metadata": { "description": "Name of the Availability Set"           } },
                 "InstanceCount":   { "type": "int",    "defaultValue": 1,  "metadata": { "description": "Number of instances to create"          } },
        "diagStorageAccountName":   { "type": "string",                     "metadata": { "description": "Name of Storage Account for diagnostics"} },
        "diskStorageAccountRoot":   { "type": "string",                     "metadata": { "description": "Name of Storage Account for vhds"       } },
                        "vmName":   { "type": "string",                     "metadata": { "description": "RootName of the VM's"                   } }
    },

	"resources": [

		{
			"name": "AS",
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "[parameters('commonSettings').resourceApiVersion]",

			"properties": {
				"mode": "incremental",
				"templateLink": { "uri": "[concat(parameters('commonSettings').commonLocation,'/availability-set.json')]" },

				"parameters": {
					"commonSettings":      { "value": "[parameters('commonSettings')]" },
					"availabilitySetName": { "value": "[parameters('availabilitySetName')]" }
				}
			}
		},



		{
			"name": "[concat(parameters('vmName'),1,'-nic0')]",
			"type": "Microsoft.Network/networkInterfaces",
			"location": "[resourceGroup().location]",
			"apiVersion": "2016-03-30",

			"properties": {
				"ipConfigurations": [
					{
						"name": "ipconfig1",
						"properties": {
							//"privateIPAllocationMethod": "Dynamic",
							"privateIPAllocationMethod": "Static",
							"privateIPAddress": "10.0.9.200",
							"subnet": { "id": "[  concat(resourceId('Microsoft.Network/virtualNetworks',  parameters('virtualNetworkParameters').virtualNetworkName),'/subnets/',parameters('virtualNetworkParameters').adSubnetName)]" }
						}
					}
				],
				"dnsSettings": {"dnsServers": [ ] }
			}
		},


		{
			"name": "[concat(parameters('vmName'),2,'-nic0')]",
			"type": "Microsoft.Network/networkInterfaces",
			"location": "[resourceGroup().location]",
			"apiVersion": "2016-03-30",

			"properties": {
				"ipConfigurations": [
					{
						"name": "ipconfig1",
						"properties": {
							//"privateIPAllocationMethod": "Dynamic",
							"privateIPAllocationMethod": "Static",
							"privateIPAddress": "10.0.9.201",
							"subnet": { "id": "[  concat(resourceId('Microsoft.Network/virtualNetworks',  parameters('virtualNetworkParameters').virtualNetworkName),'/subnets/',parameters('virtualNetworkParameters').adSubnetName)]" }
						}
					}
				],
				"dnsSettings": { "dnsServers": [ "[reference(resourceId('Microsoft.Network/networkInterfaces/',concat(parameters('vmName'),1,'-nic0'))).ipConfigurations[0].properties.privateIPAddress]" ] }
			}
		},



        {
            "name": "ADsa1",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[parameters('commonSettings').resourceApiVersion]",

            "properties": {
                "mode": "incremental",
                "templateLink": { "uri": "[concat(parameters('commonSettings').commonLocation,'/storage-account.json')]" },

                "parameters": {
                    "commonSettings":     { "value": "[       parameters('commonSettings')            ]" },
					"storageAccountName": { "value": "[concat(parameters('diskStorageAccountRoot'),1) ]" }
                }
            }
        },



        {
            "name": "ADsa2",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[parameters('commonSettings').resourceApiVersion]",

            "properties": {
                "mode": "incremental",
                "templateLink": { "uri": "[concat(parameters('commonSettings').commonLocation,'/storage-account.json')]" },

                "parameters": {
                    "commonSettings":     { "value": "[       parameters('commonSettings')            ]" },
					"storageAccountName": { "value": "[concat(parameters('diskStorageAccountRoot'),2) ]" }
                }
            }
        },



        {
            "name": "ADvm1",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[parameters('commonSettings').resourceApiVersion]",

			"dependsOn": [
				"Microsoft.Resources/deployments/AS",
				"[concat('Microsoft.Network/networkInterfaces/', parameters('vmName'), 1,'-nic0')]",
				"Microsoft.Resources/deployments/ADsa1"
			],
            
            "properties": {
                "mode": "incremental",
                "templateLink": { "uri": "[concat(parameters('commonSettings').commonLocation,'/vm-via-nic-with-availability-set.json')]" },

                "parameters": {
                    "commonSettings":         { "value": "[       parameters('commonSettings')                   ]" },
                                    "vmName": { "value": "[concat(parameters('vmName'),                1)        ]" },
					"diskStorageAccountName": { "value": "[concat(parameters('diskStorageAccountRoot'),1)        ]" },
                    "diagStorageAccountName": { "value": "[       parameters('diagStorageAccountName')           ]" },        
                                   "nicName": { "value": "[concat(parameters('vmName'),                1,'-nic0')]" },
                       "availabilitySetName": { "value": "[       parameters('availabilitySetName')]"               }
                }
            }
        },



        {
            "name": "ADvm2",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[parameters('commonSettings').resourceApiVersion]",

			"dependsOn": [
				"Microsoft.Resources/deployments/AS",
				"[concat('Microsoft.Network/networkInterfaces/', parameters('vmName'), 1,'-nic0')]",
				"Microsoft.Resources/deployments/ADsa1"
			],
            
            "properties": {
                "mode": "incremental",
                "templateLink": { "uri": "[concat(parameters('commonSettings').commonLocation,'/vm-via-nic-with-availability-set.json')]" },

                "parameters": {
                    "commonSettings":         { "value": "[       parameters('commonSettings')                   ]" },
                                    "vmName": { "value": "[concat(parameters('vmName'),                2)        ]" },
					"diskStorageAccountName": { "value": "[concat(parameters('diskStorageAccountRoot'),2)        ]" },
                    "diagStorageAccountName": { "value": "[       parameters('diagStorageAccountName')           ]" },        
                                   "nicName": { "value": "[concat(parameters('vmName'),                2,'-nic0')]" },
                       "availabilitySetName": { "value": "[       parameters('availabilitySetName')]"               }
                }
            }
        },



		{
			"name": "AD1",
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "[parameters('commonSettings').resourceApiVersion]",

			"dependsOn": [ "Microsoft.Resources/deployments/ADvm1" ],

			"properties": {
				"mode": "incremental",
				"templateLink": { "uri": "[concat(parameters('commonSettings').commonLocation,'/applyDSC.json')]" },

				"parameters": {
					"commonSettings": { "value": "[       parameters('commonSettings')    ]" },
					"vmName":         { "value": "[concat(parameters('vmName'        ),1) ]" },
					"scriptName":     { "value": "AD-First.ps1" },
					"configName":     { "value": "DemoAD1"      }
				}
			}
		},



		//{
		//	"name": "AD2",
		//	"type": "Microsoft.Resources/deployments",
		//	"apiVersion": "[parameters('commonSettings').resourceApiVersion]",

		//	"dependsOn": [ "Microsoft.Resources/deployments/ADvm2", "Microsoft.Resources/deployments/AD1" ],

		//	"properties": {
		//		"mode": "incremental",
		//		"templateLink": { "uri": "[concat(parameters('commonSettings').commonLocation,'/applyDSC.json')]" },

		//		"parameters": {
		//			"commonSettings": { "value": "[       parameters('commonSettings' ) ]" },
		//			"vmName":         { "value": "[concat(parameters('vmName')      ,2) ]" },
		//			"scriptName":     { "value": "AD-Others.ps1" },
		//			"configName":     { "value": "DemoAD2"       }
		//		}
		//	}
		//}
	]
}
