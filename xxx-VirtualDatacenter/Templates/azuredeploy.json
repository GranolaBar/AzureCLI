{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",


    "parameters": {
                  "appName": { "type": "string", "defaultValue": "myapp",                                            "metadata": { "description": "Name of Application"                            }  },
           "appEnvironment": { "type": "string", "defaultValue": "dev",   "allowedValues": [ "dev", "qa", "prod" ],  "metadata": { "description": "Environment for Application"                    }  },
         "nvaInstanceCount": { "type": "int",    "defaultValue": 2,                                                  "metadata": { "description": "Number of NVA Tier Instances to create"         }  },
         "st1InstanceCount": { "type": "int",    "defaultValue": 1,                                                  "metadata": { "description": "Number of Service Tier One instances to create" }  },
         "st2InstanceCount": { "type": "int",    "defaultValue": 3,                                                  "metadata": { "description": "Number of Service Tier Two instances to create" }  },
         "sqlinstanceCount": { "type": "int",    "defaultValue": 3,                                                  "metadata": { "description": "Number of SQL Instances to create"              }  },
        "mgmtInstanceCount": { "type": "int",    "defaultValue": 2,                                                  "metadata": { "description": "Number of Management Instances to create"       }  },
          "adInstanceCount": { "type": "int",    "defaultValue": 2,                                                  "metadata": { "description": "Number of Active Directory instances to create" }  },
         "adminAccessRange": { "type": "string", "defaultValue": "192.168.55.0/24",                                  "metadata": { "description": "Network subnet where Admins live"               }  }
    },


    "variables": {
        "apiVersion": "2016-02-01",

        "vnetAddressRange": "10.0.0.0/16",

        "st1PrivateIPAddress": "10.0.2.250",
        "st2PrivateIPAddress": "10.0.3.250",


        "diagStorageAccountName": "[concat(parameters('appName'), uniqueString(resourceGroup().id, 'diag'))]",
        "diskStorageAccountRoot": "[concat(parameters('appName'), uniqueString(resourceGroup().id, 'disk'))]",
        "appPublicIPAddressName": "[concat(parameters('appName'), uniqueString(resourceGroup().id,  'pip'))]",
         "jbPublicIPAddressName": "[concat(parameters('appName'), uniqueString(resourceGroup().id,'jbpip'))]",

        "virtualNetworkName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-vnet')]",

        "nvaLoadBalancerName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-web-lb')]",
        "st1LoadBalancerName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-st1-lb')]",
        "st2LoadBalancerName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-st2-lb')]",
        "sqlLoadBalancerName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-sql-lb')]",

         "nvaSubnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-nva-subnet')]",
         "st1SubnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-st1-subnet')]",
         "st2SubnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-st2-subnet')]",
         "sqlSubnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-sql-subnet')]",
        "mgmtSubnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-mgmt-subnet')]",
          "adSubnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),   '-ad-subnet')]",

        "nvaAvailabilitySetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-nva-as')]",
        "st1AvailabilitySetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-st1-as')]",
        "st2AvailabilitySetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-st2-as')]",
        "sqlAvailabilitySetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-sql-as')]",
         "adAvailabilitySetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-ad-as')]",

         "nvaVmName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-nva-vm')]",
         "st1VmName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-st1-vm')]",
         "st2VmName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-st2-vm')]",
         "sqlVmName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-sql-vm')]",
        "mgmtVmName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-mgmt-vm')]",
          "adVmName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),   '-ad-vm')]",

         "nvaNicName": "[concat(variables( 'nvaVmName'), '-nic')]",
        "mgmtNicName": "[concat(variables('mgmtVmName'), '-nic')]"
    },

    "resources": [

        {
                  "name": "shared",
                  "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('apiVersion')]",

            "properties": {
                "mode": "incremental",
                "templateLink": { "uri": "https://azureclisa.blob.core.windows.net/sharedresources/vdc-shared-azuredeploy.json" },

                "parameters": {
                    "apiVersion":             { "value": "[variables(            'apiVersion')]" },
                        "virtualNetworkName": { "value": "[variables(    'virtualNetworkName')]" },
                       "virtualNetworkRange": { "value": "[variables(      'vnetAddressRange')]" },
                    "diagStorageAccountName": { "value": "[variables('diagStorageAccountName')]" }
                }
            }
        },



        {
                  "name": "known",
                  "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('apiVersion')]",

            "dependsOn": [ "Microsoft.Resources/deployments/shared" ],

            "properties": {
                "mode": "incremental",
                "templateLink": { "uri": "https://azureclisa.blob.core.windows.net/sharedresources/vdc-known-azuredeploy.json" },

                "parameters": {
                    "apiVersion":             { "value": "[ variables(            'apiVersion')]"  },
                        "virtualNetworkName": { "value": "[ variables(    'virtualNetworkName')]"  },
                    "diagStorageAccountName": { "value": "[ variables('diagStorageAccountName')]"  },
                    "diskStorageAccountRoot": { "value": "[ variables('diskStorageAccountRoot')]"  },
                    "appPublicIPAddressName": { "value": "[ variables('appPublicIPAddressName')]" },
                     "jbPublicIPAddressName": { "value": "[ variables( 'jbPublicIPAddressName')]" },

                       "nvaLoadBalancerName": { "value": "[ variables(   'nvaLoadBalancerName')]" },
                             "nvaSubnetName": { "value": "[ variables(         'nvaSubnetName')]" },
                    "nvaAvailabilitySetName": { "value": "[ variables('nvaAvailabilitySetName')]" },
                                 "nvaVmName": { "value": "[ variables(             'nvaVmName')]" },
                                "nvaNicName": { "value": "[ variables(            'nvaNicName')]" },
                          "nvaInstanceCount": { "value": "[parameters(      'nvaInstanceCount')]" },

                       "st1PrivateIPAddress": { "value": "[ variables(   'st1PrivateIPAddress')]" },
                       "st1LoadBalancerName": { "value": "[ variables(   'st1LoadBalancerName')]" },
                             "st1SubnetName": { "value": "[ variables(         'st1SubnetName')]" },
                    "st1AvailabilitySetName": { "value": "[ variables('st1AvailabilitySetName')]" },
                                 "st1VmName": { "value": "[ variables(             'st1VmName')]" },
                          "st1InstanceCount": { "value": "[parameters(      'st1InstanceCount')]" },

                       "st2PrivateIPAddress": { "value": "[ variables(   'st2PrivateIPAddress')]" },
                       "st2LoadBalancerName": { "value": "[ variables(   'st2LoadBalancerName')]" },
                             "st2SubnetName": { "value": "[ variables(         'st2SubnetName')]" },
                    "st2AvailabilitySetName": { "value": "[ variables('st2AvailabilitySetName')]" },
                                 "st2VmName": { "value": "[ variables(             'st2VmName')]" },
                          "st2InstanceCount": { "value": "[parameters(      'st2InstanceCount')]" },
                       
                }
            }
        }
    ],
 "outputs": {
      "diagStorageAccountName": {"type": "string", "value": "[variables('diagStorageAccountName')]"   },
      "diskStorageAccountRoot": {"type": "string", "value": "[variables('diskStorageAccountRoot')]"   },
      "appPublicIPAddressName": {"type": "string", "value": "[variables('appPublicIPAddressName')]"   },
       "jbPublicIPAddressName": {"type": "string", "value": "[variables( 'jbPublicIPAddressName')]"   },
          "virtualNetworkName": {"type": "string", "value": "[variables(    'virtualNetworkName')]"   },
                   "nvaVmName": {"type": "string", "value": "[variables(             'nvaVmName')]"   },
                   "st1VmName": {"type": "string", "value": "[variables(             'st1VmName')]"   },
                   "st2VmName": {"type": "string", "value": "[variables(             'st2VmName')]"   },
                   "sqlVmName": {"type": "string", "value": "[variables(             'sqlVmName')]"   },
                  "mgmtVmName": {"type": "string", "value": "[variables(            'mgmtVmName')]"   },
                    "adVmName": {"type": "string", "value": "[variables(              'adVmName')]"   }
  }
}