{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",


    "parameters": {
                  "appName": { "type": "string", "defaultValue": "myapp",                                            "metadata": { "description": "Name of Application"                            }  },
           "appEnvironment": { "type": "string", "defaultValue": "dev",   "allowedValues": [ "dev", "qa", "prod" ],  "metadata": { "description": "Environment for Application"                    }  },
         "webInstanceCount": { "type": "int",    "defaultValue": 3,                                                  "metadata": { "description": "Number of Web Tier Instances to create"         }  },
         "bizInstanceCount": { "type": "int",    "defaultValue": 3,                                                  "metadata": { "description": "Number of Business Layer Instances to create"   }  },
         "sqlinstanceCount": { "type": "int",    "defaultValue": 2,                                                  "metadata": { "description": "Number of SQL Instances to create"              }  },
        "mgmtInstanceCount": { "type": "int",    "defaultValue": 1,                                                  "metadata": { "description": "Number of Management Instances to create"       }  },
         "adminAccessRange": { "type": "string", "defaultValue": "216.21.164.178",                                   "metadata": { "description": "Network subnet where Admins live"               }  }
    },


    "variables": {
        "apiVersion": "2016-02-01",

        "vnetAddressRange": "10.0.0.0/16",
        "bizPrivateIPAddress": "10.0.1.250",

        "diagStorageAccountName": "[concat(parameters('appName'), uniqueString(resourceGroup().id,'diag'))]",
        "diskStorageAccountRoot": "[concat(parameters('appName'), uniqueString(resourceGroup().id,'disk'))]",
        "appPublicIPAddressName": "[concat(parameters('appName'), uniqueString(resourceGroup().id,'pip' ))]",
         "jbPublicIPAddressName": "[concat(parameters('appName'), uniqueString(resourceGroup().id,'Jpip'))]",

            "virtualNetworkName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-vnet')]",

           "webLoadBalancerName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-web-lb')]",
           "bizLoadBalancerName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-biz-lb')]",

                "webSubnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-web-subnet')]",
                "bizSubnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-biz-subnet')]",
                "sqlSubnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-sql-subnet')]",
               "mgmtSubnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-mgmt-subnet')]",

       "webAvailabilitySetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-web-as')]",
       "bizAvailabilitySetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-biz-as')]",
       "sqlAvailabilitySetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-sql-as')]",

                    "webVmName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-web-vm')]",
                    "bizVmName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-biz-vm')]",
                    "sqlVmName": "[concat(parameters('appName'), '-', parameters('appEnvironment'),  '-sql-vm')]",
                   "mgmtVmName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-mgmt-vm')]",

                   "webNicName": "[concat(variables('webVmName'),  '-nic')]",
                   "bizNicName": "[concat(variables('bizVmName'),  '-nic')]",
                   "sqlNicName": "[concat(variables('sqlVmName'),  '-nic')]",
                  "mgmtNicName": "[concat(variables('mgmtVmName'), '-nic')]"
    },

    "resources": [

        {
                  "name": "shared",
                  "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('apiVersion')]",

            "properties": {
                "mode": "incremental",
                "templateLink": { "uri": "https://azureclisa.blob.core.windows.net/sharedresources/nTier-shared-azuredeploy.json" },

                "parameters": {
                    "apiVersion":             { "value": "[variables(            'apiVersion')]" },
                        "virtualNetworkName": { "value": "[variables(    'virtualNetworkName')]" },
                       "virtualNetworkRange": { "value": "[variables(      'vnetAddressRange')]" },
                    "diagStorageAccountName": { "value": "[variables('diagStorageAccountName')]" }
                }
            }
        },



        {
                  "name": "known",
                  "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('apiVersion')]",

            "dependsOn": [ "Microsoft.Resources/deployments/shared" ],

            "properties": {
                "mode": "incremental",
                "templateLink": { "uri": "https://azureclisa.blob.core.windows.net/sharedresources/nTier-known-azuredeploy.json" },

                "parameters": {
                    "apiVersion":             { "value": "[variables(            'apiVersion')]"  },
                        "virtualNetworkName": { "value": "[variables(    'virtualNetworkName')]"  },
                    "diagStorageAccountName": { "value": "[variables('diagStorageAccountName')]"  },
                    "diskStorageAccountRoot": { "value": "[variables('diskStorageAccountRoot')]"  },

                    "webPublicIPAddressName": { "value": "[variables( 'appPublicIPAddressName')]" },
                       "bizPrivateIPAddress": { "value": "[variables('bizPrivateIPAddress')    ]" },
                     "jbPublicIPAddressName": { "value": "[variables(  'jbPublicIPAddressName')]" },

                       "webLoadBalancerName": { "value": "[variables(   'webLoadBalancerName')]"  },
                             "webSubnetName": { "value": "[variables(         'webSubnetName')]"  },
                    "webAvailabilitySetName": { "value": "[variables('webAvailabilitySetName')]"  },
                          "webInstanceCount": { "value": "[parameters(     'webInstanceCount')]"  },
                                 "webVmName": { "value": "[variables(             'webVmName')]"  },
                                "webNicName": { "value": "[variables(            'webNicName')]"  },
                    
                       "bizLoadBalancerName": { "value": "[variables(   'bizLoadBalancerName')]"  },
                             "bizSubnetName": { "value": "[variables(         'bizSubnetName')]"  },
                    "bizAvailabilitySetName": { "value": "[variables('bizAvailabilitySetName')]"  },
                          "bizInstanceCount": { "value": "[parameters(     'bizInstanceCount')]"  },
                                 "bizVmName": { "value": "[variables(             'bizVmName')]"  },
                                "bizNicName": { "value": "[variables(            'bizNicName')]"  },

                             "sqlSubnetName": { "value": "[ variables(         'sqlSubnetName')]" },
                    "sqlAvailabilitySetName": { "value": "[ variables('sqlAvailabilitySetName')]" },
                          "sqlInstanceCount": { "value": "[parameters(      'sqlInstanceCount')]" },
                                 "sqlVmName": { "value": "[ variables(             'sqlVmName')]" },
                                "sqlNicName": { "value": "[ variables(            'sqlNicName')]" },

                            "mgmtSubnetName": { "value": "[ variables(        'mgmtSubnetName')]" },
                         "mgmtInstanceCount": { "value": "[parameters(     'mgmtInstanceCount')]" },
                                "mgmtVmName": { "value": "[ variables(            'mgmtVmName')]" },
                               "mgmtNicName": { "value": "[ variables(           'mgmtNicName')]" },
                          "adminAccessRange": { "value": "[parameters(      'adminAccessRange')]" }
                }
            }
        }
    ]
}