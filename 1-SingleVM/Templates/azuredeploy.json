{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",

    "parameters": {
               "appName": { "type": "string", "defaultValue": "myapp",                                                     "metadata": { "description": "Name of Application"                      } },
        "appEnvironment": { "type": "string", "defaultValue": "dev",   "allowedValues": [ "dev", "qa", "prod" ],           "metadata": { "description": "Environment for Application"              } },
          "templatePath": { "type": "string", "defaultValue": "https://azureclisa.blob.core.windows.net/sharedresources/", "metadata": { "description": "Path to templates for this implmentation" } },
    "commonTemplatePath": { "type": "string", "defaultValue": "https://azureclisa.blob.core.windows.net/templates/",       "metadata": { "description": "Path to core/common/reusable templatess"  } }
    },
  
    "variables": {

        "commonSettings": {
            "apiVersion": "2016-02-01",
                  "templatePath": "[parameters(      'templatePath')]",
            "commonTemplatePath": "[parameters('commonTemplatePath')]"
        },


          "diskStorageAccountName": "[concat(parameters('appName'), uniqueString(resourceGroup().id,'disk'))]",
          "diagStorageAccountName": "[concat(parameters('appName'), uniqueString(resourceGroup().id,'diag'))]",
             "publicIPAddressName": "[concat(parameters('appName'), uniqueString(resourceGroup().id,'pip' ))]",
        "networkSecurityGroupName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-nsg')]",
                      "subnetName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-subnet')]",
              "virtualNetworkName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-vnet')]",
                          "vmName": "[concat(parameters('appName'), '-', parameters('appEnvironment'), '-vm')]",
                         "nicName": "[concat( variables('vmName'),                                     '-nic0')]"
    },


    "resources": [
        {
            "name": "shared",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('commonSettings').apiVersion]",

            "properties": {
                "mode": "incremental",
                "templateLink": { "uri": "[concat(parameters('templatePath'),'singlevm-shared-azuredeploy.json')]" },

                "parameters": {
                              "commonSettings": { "value": "[variables('commonSettings')]"           },
                    "networkSecurityGroupName": { "value": "[variables('networkSecurityGroupName')]" },
                          "virtualNetworkName": { "value": "[variables(      'virtualNetworkName')]" },
                                  "subnetName": { "value": "[variables(              'subnetName')]" }
                }
            }
        },



        {
            "name": "known",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('commonSettings').apiVersion]",

            "dependsOn": [ "Microsoft.Resources/deployments/shared" ],
           
            "properties": {
                "mode": "incremental",
                "templateLink": { "uri": "[concat(parameters('templatePath'),'singlevm-known-azuredeploy.json')]" },

                "parameters": {
                              "commonSettings": { "value": "[variables('commonSettings')]"         },
                      "diskStorageAccountName": { "value": "[variables('diskStorageAccountName')]" },
                      "diagStorageAccountName": { "value": "[variables('diagStorageAccountName')]" },
                         "publicIPAddressName": { "value": "[variables(   'publicIPAddressName')]" },
                                  "subnetName": { "value": "[variables(            'subnetName')]" },
                          "virtualNetworkName": { "value": "[variables(    'virtualNetworkName')]" },
                                      "vmName": { "value": "[variables(                'vmName')]" },
                                     "nicName": { "value": "[variables(               'nicName')]" }
                }
            }
        } 
      
    ],

  "outputs": {
      "diskStorageAccountName": {"type": "string", "value": "[variables('diskStorageAccountName')]"   },
      "diagStorageAccountName": {"type": "string", "value": "[variables('diagStorageAccountName')]"   },
         "publicIPAddressName": {"type": "string", "value": "[variables('publicIPAddressName')]"      },
    "networkSecurityGroupName": {"type": "string", "value": "[variables('networkSecurityGroupName')]" },
                  "subnetName": {"type": "string", "value": "[variables('subnetName')]"               },
          "virtualNetworkName": {"type": "string", "value": "[variables('virtualNetworkName')]"       },
                      "vmName": {"type": "string", "value": "[variables('vmName')]"                   },
                     "nicName": {"type": "string", "value": "[variables('nicName')]"                  }
  }

}