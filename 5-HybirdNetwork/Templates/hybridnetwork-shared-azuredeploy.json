{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    
    "parameters": {
      "localGatewayName":  { "type": "string", "defaultValue": "localGateway",                "metadata": { "description": "Arbitrary name for gateway resource representing your local/on-prem gateway"                                     } },
 "localGatewayIpAddress":  { "type": "string", "defaultValue": "1.1.1.1",                     "metadata": { "description": "Public IP of your local/on-prem gateway"                                                                         } },
    "localAddressPrefix":  { "type": "string", "defaultValue": "192.168.0.0/16",              "metadata": { "description": "CIDR block representing the address space of your local/on-prem network's Subnet"                                } },
    "virtualNetworkName":  { "type": "string", "defaultValue": "azurevnetval",                "metadata": { "description": "Arbitrary name for the Azure Virtual Network"                                                                    } },
"azureVNetAddressPrefix":  { "type": "string", "defaultValue": "10.1.0.0/16",                 "metadata": { "description": "CIDR block representing the address space of the Azure VNet"                                                     } }, 
           "subnetName1":  { "type": "string", "defaultValue": "myappsubnet1",                "metadata": { "description": "Arbitrary name for the Azure Subnet"                                                                             } },
           "subnetName2":  { "type": "string", "defaultValue": "myappsubnet2",                "metadata": { "description": "Arbitrary name for the Azure Subnet"                                                                             } },
         "subnetPrefix1":  { "type": "string", "defaultValue": "10.1.1.0/24",                 "metadata": { "description": "CIDR block for VM subnet1, subset of azureVNetAddressPrefix address space"                                       } },
         "subnetPrefix2":  { "type": "string", "defaultValue": "10.1.2.0/24",                 "metadata": { "description": "CIDR block for VM subnet2, subset of azureVNetAddressPrefix address space"                                       } },
   "gatewaySubnetPrefix":  { "type": "string", "defaultValue": "10.1.254.0/24",               "metadata": { "description": "CIDR block for gateway subnet, subset of azureVNetAddressPrefix address space"                                   } },
   "gatewayPublicIPName":  { "type": "string", "defaultValue": "azureGatewayIP",              "metadata": { "description": "Arbitrary name for public IP resource used for the new azure gateway"                                            } },
            "gatewaySku":  { "type": "string", "defaultValue": "Standard",                    "metadata": { "description": "The Sku of the Gateway. This must be one of Basic, Standard or HighPerformance."                                 } },        
           "gatewayName":  { "type": "string", "defaultValue": "azureGateway",                "metadata": { "description": "Arbitrary name for the new gateway"                                                                              } },
        "connectionName":  { "type": "string", "defaultValue": "Azure2onprem",                "metadata": { "description": "Arbitrary name for the new connection between Azure VNet and other network"                                      } },
             "sharedKey":  { "type": "string", "defaultValue": "abc123",                      "metadata": { "description": "Shared key (PSK) for IPSec tunnel"                                                                               } },
               "vpnType":  { "type": "string", "defaultValue": "RouteBased",                  "metadata": { "description": "Route based (Dynamic Gateway) or Policy based (Static Gateway)" }, "allowedValues": ["RouteBased","PolicyBased"] } },
     
     
     "variables": {
                        "vnetID":  "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
             "gatewaySubnetName":  "GatewaySubnet",
              "gatewaySubnetRef":  "[concat(parameters('virtualNetworkName'),'/subnets/','GatewaySubnet')]",
                     "subnetRef":  "[concat(parameters('virtualNetworkName'),'/subnets/',parameters('subnetName1'))]",
            "addressSpacePrefix":  "10.0.0.0/16",
       "addressSpaceSubnet1Name":  "Subnet-1",
     "addressSpaceSubnet1Prefix":  "10.0.0.0/24",
       "addressSpaceSubnet2Name":  "Subnet-2",
     "addressSpaceSubnet2Prefix":  "10.0.1.0/24"
   },
        
     "resources": [
      {
                    "apiVersion": "2016-03-30",
                          "type": "Microsoft.Network/virtualNetworks",
                          "name": "[parameters('virtualNetworkName')]",
                      "location": "[resourceGroup().location]",
                    "properties": {
                  "addressSpace": {
               "addressPrefixes": ["[parameters('azureVNetAddressPrefix')]" ] },
                       "subnets": [
            {
                          "name": "[parameters('subnetName1')]",
                    "properties": {
                 "addressPrefix": "[parameters('subnetPrefix1')]"
              }
            },
              {
                          "name": "[variables('gatewaySubnetname')]",
                    "properties": {
                 "addressPrefix": "[parameters('gatewaySubnetPrefix')]"
                }
              }
            ]
          }
      },
      {
                    "apiVersion": "2016-03-30" ,
                          "type": "Microsoft.Network/localNetworkGateways",
                          "name": "[parameters('localGatewayName')]",
                      "location": "[resourceGroup().location]",
                    "properties": {
      "localNetworkAddressSpace": {
               "addressPrefixes": ["[parameters('localAddressPrefix') ]"
            ]
          },
            "gatewayIpAddress":"[parameters('localGatewayIpAddress')]"
              }
           },
      {
                    "apiVersion": "2016-01-29",
                          "name": "[parameters('connectionName')]",
                          "type": "Microsoft.Network/connections",
                      "location": "[resourceGroup().location]",
                     "dependsOn": [
                                   "[concat('Microsoft.Network/virtualNetworkGateways/', parameters('gatewayName'))]",
                                   "[concat('Microsoft.Network/localNetworkGateways/', parameters('localGatewayName'))]" ],
                           
                    "properties": {
        "virtualNetworkGateway1": {
                            "id": "[resourceId('Microsoft.Network/virtualNetworkGateways', parameters('gatewayName'))]"  },
          "localNetworkGateway2": {
                            "id": "[resourceId('Microsoft.Network/localNetworkGateways', parameters('localGatewayName'))]" 
            },
                "connectionType": "IPsec",
                 "routingWeight": 10,
                     "sharedKey": "[parameters('sharedKey')]"
                  }
             },
         {
                    "apiVersion": "2016-03-30",
                          "type": "Microsoft.Network/publicIPAddresses",
                          "name": "[parameters('gatewayPublicIPName')]",
                      "location": "[resourceGroup().location]",
                    "properties": {
      "publicIPAllocationMethod": "Dynamic"
          }
      },
      {
                    "apiVersion": "2016-03-30",
                          "type": "Microsoft.Network/virtualNetworkGateways",
                          "name": "[parameters('gatewayName')]",
                      "location": "[resourceGroup().location]",
                     "dependsOn": [
                                  "[concat('Microsoft.Network/publicIPAddresses/', parameters('gatewayPublicIPName'))]",
                                  "[concat('Microsoft.Network/virtualNetworks/', parameters('virtualNetworkName'))]"
        ],
                   "properties" : {
              "ipConfigurations": [
            {
                    "properties": {
     "privateIPAllocationMethod": "Dynamic",
                        "subnet": {
                            "id": "[variables('gatewaySubnetRef')]"
                },
               "publicIPAddress": {
                            "id": "[resourceId('Microsoft.Network/publicIPAddresses',parameters('gatewayPublicIPName'))]"
                }
              },
                          "name": "vnetGatewayConfig"
            }
          ],
                           "sku": {
                          "name": "[parameters('gatewaySku')]",
                          "tier": "[parameters('gatewaySku')]"
          },
                   "gatewayType": "Vpn",
                       "vpnType": "[parameters('vpnType')]",
                     "enableBgp": "false"
                 }
           }
      ]
}
    
